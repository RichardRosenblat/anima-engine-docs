# ADR-004: Observabilidad, Registro de Eventos y Trazabilidad de Ejecución

**Estado:** Aceptado  
**Fecha:** 2026-01-03  
**Decisores:** @RichardRosenblat  
**Contexto:** Observabilidad, Depurabilidad, Determinismo, Concurrencia, Auditabilidad, Distribución Futura  

---

## Contexto

ANIMA es un sistema altamente modular y concurrente compuesto por:

* un Núcleo de razonamiento
* múltiples Módulos ejecutándose independientemente
* invocaciones asíncronas de capacidades
* hilos de ejecución concurrentes
* leases limitados por tiempo y decisiones de seguridad

Los enfoques tradicionales de registro basados en:

* líneas de texto no estructuradas
* archivos de log globales
* ordenación solo por tiempo

son insuficientes y activamente perjudiciales en este contexto.

Fallan en proporcionar:

* relaciones causales
* límites de ejecución
* claridad de concurrencia
* reproducibilidad
* trazabilidad de nivel de auditoría

ANIMA requiere observabilidad que refleje **lo que realmente sucede**, no solo *cuándo* algo imprimió texto.

---

## Declaración del Problema

El sistema debe soportar:

* múltiples ejecuciones concurrentes
* hilos de razonamiento paralelos
* módulos distribuidos
* clustering futuro
* auditoría de seguridad
* depuración legible por humanos
* análisis legible por máquinas

Sin estructura y aislamiento estrictos, los datos de observabilidad se vuelven:

* ambiguos
* inseguros para interpretar
* difíciles de correlacionar
* imposibles de reproducir confiablemente

---

## Decisión

### 1. Modelo de Observabilidad Basado en Eventos

ANIMA **no** produce líneas de log tradicionales.

En cambio, **toda salida de observabilidad se expresa como eventos estructurados**.

Un evento representa un **hecho** que ocurrió en el sistema.

Los eventos son:

* inmutables
* append-only
* marcados con timestamp
* causalmente vinculados
* con alcance de ejecución

---

### 2. Ejecución como Límite de Partición Primario

Todos los datos de observabilidad DEBEN particionarse por **ejecución**.

Una **ejecución** se define como:

* un runtime del Núcleo limitado
* un único universo causal
* el límite de aislamiento de nivel más alto para observabilidad

Cada ejecución recibe un único globalmente único:

```
execution_id
```

Este ID:

* es generado por el Núcleo en el inicio (o creación explícita de ejecución)
* se adjunta a **cada evento**
* se propaga a **todos los Módulos**
* se incluye en contextos de lease

El tiempo solo NO DEBE usarse como clave de partición primaria.

---

### 3. Sinks de Eventos Basados en Archivo (Implementación Inicial)

Para desarrollo inicial y ejecución local, ANIMA usa **sinks basados en archivo**.

El diseño de archivo está **particionado por ejecución**:

```text
events/
  executions/
    exec-<uuid>/
      metadata.json
      events.ndjson
```

Donde:

* `metadata.json` describe el contexto de ejecución
* `events.ndjson` es un stream de eventos JSON delimitado por nueva línea append-only

---

### 4. Metadatos de Ejecución

Cada directorio de ejecución DEBE contener metadatos describiendo la ejecución.

Ejemplo:

```json
{
  "execution_id": "exec-9f3c2a7e",
  "started_at": "2026-01-01T18:04:12Z",
  "ended_at": null,
  "core_version": "0.4.0",
  "host": "anima-core-01"
}
```

Estos metadatos proporcionan:

* contexto humano
* trazabilidad de auditoría
* anclaje de replay

---

### 5. Estructura de Evento (Campos Obligatorios)

Cada evento DEBE incluir como mínimo:

```json
{
  "execution_id": "exec-uuid",
  "trace_id": "trace-uuid",
  "span_id": "span-uuid",
  "parent_span_id": null,
  "thread_id": "ctx-identifier",
  "timestamp": "RFC3339",
  "source": "core | module:<name>",
  "type": "event.type.identifier",
  "instance_urn": "anima:instance:<instance-id>",
  "core_urn": "anima:core:<core-id>",
  "payload": {}
}
```

#### Responsabilidades semánticas:

* **execution_id** → aislamiento de ejecución
* **trace_id** → cadena causal de extremo a extremo
* **span_id / parent_span_id** → estructura jerárquica
* **thread_id** → visibilidad de concurrencia
* **type** → significado semántico (estable, documentado)
* **instance_urn** → identificador único para el runtime de la instancia ANIMA
* **core_urn** → identificador único para la instalación del Núcleo
* **payload** → solo datos estructurados (sin texto libre)

---

### 6. Garantías de Concurrencia y Multihilo

La observabilidad DEBE soportar ejecución concurrente.

Esto se logra mediante:

* aislamiento de archivo a nivel de ejecución
* escrituras append-only
* identificadores a nivel de hilo en eventos

No hay **ningún requisito** de ordenación total entre hilos.
La ordenación se deriva de:

* relaciones de trace
* jerarquías de span
* timestamps como contexto secundario

---

### 7. Legibilidad Humana y Visualización de Línea de Tiempo

Aunque los eventos son JSON legible por máquina, el modelo está diseñado para soportar:

* visualizadores de línea de tiempo
* vistas filtradas (por trace, hilo, módulo)
* árboles de span plegables
* herramientas de replay

La legibilidad humana se logra a través de:

* esquemas estructurados
* tipos de evento estables
* campos determinísticos
* herramientas (no texto ad-hoc)

Los archivos sin procesar no están destinados a leerse directamente.

---

### 8. Participación de Módulos

Todos los Módulos DEBEN:

* emitir eventos usando el mismo esquema
* incluir execution_id propagado del Núcleo
* respetar contexto de trace y span proporcionado por el Núcleo
* nunca emitir eventos fuera de un contexto de ejecución

Los módulos NO DEBEN:

* escribir directamente en archivos del Núcleo
* inventar execution IDs
* mezclar datos de múltiples ejecuciones

---

### 9. Extensiones Futuras

Este ADR intencionalmente permite sinks futuros, incluyendo:

* almacenamientos de eventos centralizados
* pipelines de streaming
* backends de observabilidad
* sistemas de trace distribuido

Todas las implementaciones futuras DEBEN preservar:

* particionamiento de ejecución
* semántica de evento inmutable
* trazabilidad causal

---

## Consecuencias

### Positivas

* Aislamiento claro de ejecución
* Reproducibilidad determinística
* Concurrencia segura
* Observabilidad de nivel de auditoría
* Base sólida para herramientas
* Sin ambigüedad de intercalación de log

### Negativas

* Requiere disciplina de esquema inicial
* Herramientas necesarias para visualización
* Menos "depuración por impresión" inmediata

Estos tradeoffs son intencionales y alineados con los objetivos de ANIMA.

---

## No-Objetivos

Este ADR **no** define:

* dashboards en tiempo real
* sistemas de alerta
* infraestructura de agregación de log
* políticas de almacenamiento a largo plazo
* UX de herramientas de visualización

Estos se abordan por separado.

---

## Resumen

> **ANIMA no registra texto.
> ANIMA registra hechos.**
>
> La observabilidad es:
>
> * estructurada
> * con alcance de ejecución
> * causalmente trazable
> * segura para concurrencia
>
> La ejecución es el límite fundamental.
> Los eventos son la fuente de verdad.
