# ADR-002: Esquemas Auto-Validables con Restricciones Solo Internas

## Estado
**Estado:** Aceptado  
**Fecha:** 2025-12-31  
**Decisores:** @RichardRosenblat  
**Contexto:** Diseño de esquema, pureza de dominio, integridad de datos  

## Contexto

ANIMA depende fuertemente de esquemas de datos estructurados para definir:

- registros de memoria
- representaciones de intención
- planes y estructuras semánticas
- definiciones de seed
- descriptores de capacidad

Estos esquemas forman la **fundación de la corrección del motor**.  
Datos inválidos o internamente inconsistentes en este nivel pueden comprometer seguridad, continuidad de identidad e integridad del razonamiento.

Al mismo tiempo, ANIMA sigue una arquitectura hexagonal estricta, donde:

- los esquemas pertenecen a la **capa de dominio pura**
- el código de dominio no debe depender de sistemas externos, estado o IO

Esto plantea la pregunta:

> ¿Deben los esquemas tener permiso para validarse a sí mismos, y de ser así, bajo qué restricciones?

---

## Decisión

Los esquemas **PUEDEN** incluir lógica de auto-validación **solo si**:

1. La validación:
   - usa **solo los datos contenidos dentro de la instancia del esquema**
   - depende exclusivamente de lógica pura
2. La validación:
   - **no** consulta estado externo
   - **no** depende de instancias de runtime de otros esquemas
   - **no** realiza IO, acceso al sistema de archivos o llamadas de red
3. La validación:
   - es determinística
   - produce el mismo resultado para los mismos datos de entrada

Los esquemas **NO DEBEN** realizar validación que requiera:

- acceso a base de datos
- almacenamientos de memoria
- estado del motor
- historial del usuario
- inferencia de modelo
- condiciones basadas en tiempo o ambiente

Si la validación requiere datos o contexto externos, **DEBE** implementarse en una capa superior (ej: validadores de seed, servicios del motor o políticas de seguridad).

---

## Ejemplos

### ✅ Permitido (Consistencia Interna)

- Verificaciones de rango de campos
- Validación de pertenencia a enum
- Consistencia entre campos dentro del mismo esquema
- Reglas de integridad estructural

```python
@dataclass(frozen=True)
class SemanticFact:
    content: str
    confidence: float

    def validate(self) -> None:
        if not (0.0 <= self.confidence <= 1.0):
            raise ValueError("confidence must be between 0 and 1")
```

### ❌ Prohibido (Dependencia Externa)

* Verificar si una entidad referenciada existe en memoria
* Verificar permisos
* Consultar interacciones históricas
* Llamar servicios del motor o adaptadores

```python
# ❌ No permitido en esquema
def validate(self, memory_store):
    if not memory_store.exists(self.reference_id):
        ...
```

---

## Justificación

Permitir **validación solo interna** proporciona:

* Detección temprana de errores
* Garantías de datos más fuertes
* Propiedad clara de invariantes
* Propagación reducida de estado inválido

Restringir esquemas a **validación autocontenida** preserva:

* Pureza de la capa de dominio
* Testabilidad
* Comportamiento determinístico
* Flujo de dependencia limpio hacia adentro

Esto equilibra seguridad y disciplina arquitectónica sin convertir esquemas en mini-servicios.

---

## Consecuencias

### Positivas

* Los esquemas son robustos y auto-defensivos
* Los datos inválidos fallan rápido y localmente
* La lógica central del motor puede confiar en invariantes de esquema

### Negativas

* Alguna lógica de validación debe duplicarse o diferirse a capas superiores
* Los desarrolladores deben pensar cuidadosamente sobre el posicionamiento de validación

Este tradeoff es intencional y alineado con el énfasis de ANIMA en corrección sobre conveniencia.

---

## Aplicación

* Los módulos de esquema NO DEBEN importar servicios del motor, adaptadores o código de runtime
* Los métodos de validación de esquema DEBEN ser fácilmente probables en aislamiento
* Las revisiones de código DEBEN rechazar validación de esquema que dependa de contexto externo

---

## Notas

Este ADR **no** exige que todos los esquemas implementen validación — solo que **si la validación existe**, debe respetar estas restricciones.
