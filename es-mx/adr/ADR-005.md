# ADR-005: Modelo de Interrupción y Preferencia

**Estado:** Aceptado  
**Fecha:** 2026-01-03  
**Decisores:** @RichardRosenblat  
**Contexto:** Interacción, Seguridad, Control en Tiempo Real, Observabilidad, Determinismo  

---

## Contexto

ANIMA está diseñada para operar en **entornos interactivos en vivo** donde usuarios, sistemas y sensores pueden proporcionar entrada mientras la instancia ya está:

* hablando
* razonando
* ejecutando un plan
* invocando capacidades de larga duración
* interactuando con el mundo externo

En tales entornos, **las interrupciones son inevitables**.

El manejo ingenuo de interrupciones (ej: matar hilos, cancelaciones forzadas, flags ad-hoc) introduce riesgos severos:

* estado interno inconsistente
* acciones parcialmente ejecutadas
* pérdida de auditabilidad
* comportamiento no determinístico
* efectos secundarios externos inseguros

Por lo tanto, ANIMA requiere un **modelo de interrupción formal, determinístico y observable** que preserve seguridad y claridad arquitectónica mientras permite interacción natural.

---

## Decisión

### 1. Las Interrupciones Son Eventos de Primera Clase

Las interrupciones **no son excepciones**, señales o canales laterales.

Todas las interrupciones DEBEN entrar al sistema como **eventos de entrada estructurados**, procesados por el Núcleo como cualquier otra entrada.

Los ejemplos incluyen:

* habla del usuario mientras ANIMA está hablando
* comandos del usuario emitidos durante ejecución
* disparadores de seguridad del sistema
* alertas emitidas por capacidades

Las interrupciones DEBEN ser:

* observables
* auditables
* reproducibles
* atribuibles a una fuente

---

### 2. Modelo de Ejecución: Spans y Foco

Toda actividad del Núcleo se representa como **spans de ejecución**, cada uno con:

* un `span_id` único
* un `execution_id` asociado
* una bandera `interruptible` declarada
* una política de interrupción

En cualquier momento, el Núcleo mantiene un **span de foco en primer plano**.

Por defecto:

* solo el span en primer plano puede ser interrumpido
* el trabajo en segundo plano continúa a menos que se escale explícitamente

Esto previene cancelación en cascada descontrolada.

---

### 3. La Interruptibilidad Es Explícita

Ninguna acción es interrumpible por defecto.

Solo los spans que declaren explícitamente:

```yaml
interruptible: true
```

pueden ser interrumpidos.

Esto incluye, pero no se limita a:

* streaming de habla
* escucha
* movimiento
* espera
* ejecución de capacidad de larga duración

Los spans no interrumpibles DEBEN ignorar eventos de interrupción.

---

### 4. Clasificación de Interrupción

Al recibir un evento de interrupción, el Núcleo DEBE clasificarlo antes de actuar.

Las clases de interrupción soportadas incluyen:

| Clase           | Semántica                                    |
| --------------- | -------------------------------------------- |
| `override`      | Reemplazar ejecución actual en primer plano  |
| `cancel`        | Detener la ejecución actual                  |
| `queue`         | Diferir hasta que complete ejecución actual  |
| `clarification` | Interrumpir para solicitar aclaración        |
| `emergency`     | Parada inmediata, omitiendo flujo normal     |

La clasificación es un **paso de razonamiento**, no un reflejo.

---

### 5. Políticas de Interrupción de Capacidades

Las capacidades que exponen métodos interrumpibles DEBEN declarar una **política de interrupción** por método.

Las políticas soportadas incluyen:

| Política            | Comportamiento                              |
| ------------------- | ------------------------------------------- |
| `soft-stop`         | Detener en un límite seguro (ej: fin buffer)|
| `hard-stop`         | Terminación inmediata                       |
| `checkpointed`      | Revertir al último checkpoint seguro        |
| `non-interruptible` | Rechazar todas las interrupciones           |

El Núcleo DEBE respetar políticas declaradas.
Las capacidades DEBEN aplicarlas localmente.

---

### 6. Flujo de Manejo de Interrupción

Cuando ocurre una interrupción:

1. Se emite un evento de entrada de interrupción
2. El Núcleo evalúa:

   * span actual en primer plano
   * interruptibilidad
   * clasificación de interrupción
   * umbrales de seguridad y confianza
3. Si se permite:

   * el span objetivo se marca como `interrupted`
   * se envía una directiva de interrupción a la capacidad (si aplica)
4. El span interrumpido:

   * termina de acuerdo con su política
   * emite eventos de conclusión o cancelación
5. Comienza un **nuevo trazo de ejecución**

Los trazos interrumpidos **nunca se mutan o eliminan**.

---

### 7. Hablar Mientras Habla (Caso Canónico)

Si ANIMA está hablando activamente y se detecta habla del usuario:

* la detección de habla entra como evento de interrupción
* el Núcleo evalúa confianza y permisos
* si se clasifica como `override` o `cancel`:

  * el span de habla se interrumpe
  * la capacidad de voz ejecuta un `soft-stop`
  * el control vuelve al Núcleo
  * comienza una nueva ejecución

No se permite terminación forzada de procesos.

---

### 8. Seguridad y Mitigación de Abuso

Las interrupciones pueden ser maliciosas o accidentales.

El Núcleo DEBE aplicar:

* umbrales de confianza (ej: certeza de habla)
* límites de tasa
* permisos basados en rol
* reglas de escalación para interrupciones de emergencia

Ejemplos:

* solo roles privilegiados pueden emitir interrupciones `emergency`
* entradas de baja confianza pueden encolarse o ignorarse

---

### 9. Observabilidad y Trazabilidad

Todas las interrupciones DEBEN generar eventos de línea de tiempo, incluyendo:

* fuente de la interrupción
* span objetivo
* clasificación
* política aplicada
* resultado

Esto se integra directamente con el modelo de observabilidad basado en eventos definido en ADR-004.

Las interrupciones DEBEN ser claramente visibles en líneas de tiempo de ejecución.

---

## Consecuencias

### Positivas

* Interacción natural, similar a la humana
* Comportamiento de interrupción determinístico
* Fuertes garantías de seguridad
* Auditabilidad y reproducibilidad completas
* Separación limpia entre entrada, razonamiento y ejecución

### Negativas

* Complejidad de modelado aumentada
* Requiere diseño explícito de capacidades
* Más disciplina inicial en modelado de ejecución

Estos tradeoffs son intencionales.

---

## No-Objetivos

Este ADR **no** define:

* patrones de interacción UI/UX
* algoritmos de confianza de reconocimiento de habla
* manejo de interrupción a nivel de hardware
* programación de SO en tiempo real

Estos se delegan a módulos y capas de infraestructura.

---

## Resumen

> **Las interrupciones en ANIMA son eventos de entrada estructurados y clasificados que preemptan ejecución de manera controlada, observable y determinística.**

Son:

* explícitas
* gobernadas por política
* auditables
* seguras por construcción

Este modelo permite interacción en tiempo real sin sacrificar integridad arquitectónica.
