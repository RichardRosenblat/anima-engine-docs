# ADR-003: Protocolo de Comunicación Core ↔ Module, Tipos de Módulos y Ciclo de Vida de Leases

**Estado:** Aceptado  
**Fecha:** 2026-01-01  
**Decisores:** @RichardRosenblat  
**Contexto:** Seguridad, Aislamiento, Determinismo, Observabilidad, Distribución Futura  

---

## Contexto

ANIMA está diseñado como un sistema modular donde el **Core Engine** interactúa con **Módulos / Capacidades** desarrollados e implementados independientemente.

Los módulos deben:

* Ejecutarse en procesos separados
* Ser descubiertos dinámicamente
* Cumplir con las garantías estrictas de seguridad y aislamiento de ANIMA

Los mecanismos de comunicación entre procesos sin restricciones (por ejemplo, sockets sin procesar, REST, memoria compartida, ejecución de shell) introducen riesgos inaceptables que incluyen escalada de privilegios, límites de confianza poco claros, ataques de repetición, comportamiento no auditable y modos de falla indefinidos.

Por lo tanto, la comunicación entre el Core y los Módulos debe ser **estrictamente restringida**, **criptográficamente verificable**, **auditable** y **segura ante fallas parciales**.
Además, los ciclos de vida de los módulos deben estar explícitamente tipados y aplicados para garantizar una ejecución predecible, contención y control de recursos.

---

## Decisión

---

## 1. Mecanismo Único de Comunicación

**Toda comunicación entre un ANIMA Core y los Módulos DEBE ocurrir a través de:**

> **gRPC sobre Conexiones TLS mutuamente autenticadas (mTLS)**

No se permite ningún transporte alternativo, mecanismo IPC o protocolo.
Este requisito se aplica uniformemente a implementaciones locales, remotas y distribuidas.

---

## 2. Seguridad de Transporte e Identidad

* Todas las conexiones DEBEN usar cifrado TLS.
* La comunicación en texto plano está prohibida, incluso en `localhost`.
* Tanto el Core como el Módulo DEBEN presentar certificados verificables.
* Los certificados DEBEN codificar identidades estables:

  * **URN de Instancia del Core**
  * **URN del Módulo**

La autenticación de transporte establece **solo identidad**, nunca autorización.

---

## 3. Modelo de Autorización Basado en Leases

### 3.1 Modelo Mental de Lease

Un lease se entiende como:

> **Mandato Criptográfico de una Conexión Entre un Core y un Módulo, junto con las Acciones Permitidas realizadas a través de ella**

Un lease DEBE contener:

* ID de Conexión (ID del Lease)
* Identidad del consumidor (Core / URN de Instancia del Core)
* Identidad del proveedor (URN del Módulo)
* Métodos de capacidad permitidos (alcance)
* Tiempo de expiración
  *(limitado por la duración máxima declarada en el Contrato de Capacidad del Módulo)*

---

### 3.2 Autoridad de Lease (Invariante Crítica)

> **El Core es la única y canónica autoridad capaz de emitir, renovar, modificar o revocar leases.**

Los módulos:

* NO DEBEN emitir, extender o modificar leases
* PUEDEN solo reconocer, aplicar o rechazar la ejecución basándose en un lease emitido por el Core

Esto elimina toda simetría de autorización y previene el comportamiento split-brain.

---

### 3.3 Handshake y Establecimiento de Lease

1. Se establece un canal mTLS seguro.
2. El Core inicia un handshake declarando intención y capacidades solicitadas.
3. El Módulo responde con **solo atestación**:
   * Identidad
   * Hash del contrato de capacidad
   * Tipo de módulo declarado
   * Duración máxima de lease permitida
4. El Core valida la atestación **off-wire**.
5. Si se acepta, el Core emite una **Concesión de Lease firmada**.
6. El Módulo reconoce el lease y lo vincula al estado interno.

> **Un lease se vuelve válido solo después del reconocimiento explícito por parte del Módulo.**

---

### 3.4 Épocas de Lease y Anti-Desincronización

Cada lease incluye una **Época de Lease monotónica**.

* Las épocas comienzan en `1` y se incrementan en:

  * Renovación
  * Cambio de alcance
  * Revocación
* El Core es la única autoridad de época.

**Cada solicitud DEBE llevar prueba criptográfica vinculada a:**

* ID del Lease
* Época del Lease
* ID de Solicitud / nonce

Las solicitudes con épocas obsoletas o no coincidentes DEBEN ser rechazadas inmediatamente.

Esto previene:

* Ataques de repetición
* Desincronización silenciosa
* Fallas de revocación parcial

---

### 3.5 Validez de Lease y Disciplina de Reloj

* La expiración del lease se evalúa usando:

  * Una tolerancia acotada de desfase de reloj
  * Renovaciones periódicas impulsadas por el Core
* Los módulos DEBEN tratar la expiración de manera conservadora:

  * Si la validez es incierta → se rechaza la ejecución

No hay **confianza implícita** en los relojes de pared locales.

---

### 3.6 Semántica de Revocación de Lease

* La revocación de lease por parte del Core es autoritativa y final.
* Cualquier rechazo explícito de comunicación por cualquier parte DEBE:

  * Invalidar inmediatamente el lease localmente
  * Activar el manejo de revocación en el Core

No existe un estado de lease "medio-válido".

---

### 3.7 Promoción y Degradación del Alcance de Lease

El alcance del lease define el **conjunto exacto de métodos de capacidad** que un Módulo está autorizado a ejecutar para un Core dado.
El alcance **no es estático**, pero la **expansión del alcance está estrictamente controlada**.

> **El alcance solo puede cambiar a través de una actualización de lease emitida explícitamente por el Core.**

---

#### 3.7.1 Autoridad y Direccionalidad

* Solo el **Core** puede otorgar, promover o degradar el alcance del lease.
* Los módulos NO DEBEN ampliar el alcance de manera autónoma.

---
#### 3.7.2 Actualización de Alcance mediante Incremento de Época de Lease

Si el Core requiere un cambio de alcance:

* Se DEBE emitir una **nueva época de lease**
* El alcance actualizado DEBE reemplazar completamente el alcance anterior
* La época anterior es inmediatamente inválida

El Core emite una **Actualización de Lease** firmada que contiene:

* ID del Lease
* Nueva Época de Lease
* Alcance permitido completo
* Tiempo de expiración (sin cambios o acortado)
* Restricciones de ejecución opcionales

---

#### 3.7.3 Reglas de Aplicación del Módulo

Al recibir una actualización de lease, el Módulo DEBE:

* Validar la firma del Core
* Verificar la monotonicidad de la época
* Reemplazar atómicamente su contexto de lease local
* Rechazar **todas las solicitudes** que lleven la época antigua

Si ocurre una promoción de alcance durante la ejecución:

* La ejecución DEBE continuar **solo si** el método en curso permanece dentro de ambos:

  * Alcance antiguo
  * Alcance nuevo
* De lo contrario, la ejecución DEBE detenerse en el siguiente punto de interrupción

---

#### 3.7.6 Degradación de Alcance y Reducción de Emergencia

El Core PUEDE degradar el alcance en cualquier momento, incluyendo:

* Incidentes de seguridad
* Cambios de política
* Mal comportamiento observado

Degradación:

* Entra en vigor inmediatamente después del incremento de época
* No requiere reconocimiento del Módulo para ser aplicada

---

#### 3.7.7 Invariantes de Seguridad

> * Un Módulo nunca puede ejecutar un método de capacidad que no fue otorgado explícitamente en la **época de lease actual**.
> * La promoción de alcance **nunca es implícita**, **nunca es acumulativa**, y **nunca es simétrica**.
> * Cada cambio de alcance es auditable y seguro contra repetición.

---

#### 3.7.8 Semántica de Falla

Si:

* Se pierde una actualización de alcance
* Las épocas divergen
* O la validez es incierta

Entonces:

> **El Módulo DEBE fallar cerrado y rechazar la ejecución.**

---

## 4. Contrato de Interfaz de Capacidad

* Cada Módulo DEBE exponer una interfaz de servicio gRPC estrictamente definida y estática.
* Los métodos expuestos DEBEN corresponder exactamente a los métodos de capacidad declarados.
* La invocación reflexiva, dinámica o ad-hoc está prohibida.
* Los contratos de capacidad DEBEN declarar:

  * Clase de efecto secundario (puro / reversible / irreversible)
  * Garantías de abortabilidad

---

## 5. Estado de Lease-Cero

### 5.1 Definición

Un Módulo está en **Estado de Lease-Cero** cuando no tiene un lease actualmente válido.

Esto ocurre en:

* Expiración de lease
* Revocación de lease
* Pérdida de conexión
* Falla al establecer un lease dentro de una ventana de inicialización acotada

---

### 5.2 Invariante del Core

> **Sin Lease, Sin Ejecución**

Un módulo sin lease válido:

* DEBE rechazar toda ejecución de capacidad
* NO DEBE realizar efectos secundarios
* NO DEBE procesar tareas en segundo plano en nombre de un Core

---


## 6. Tipos de Módulos y Semántica de Ciclo de Vida

Cada Módulo ANIMA DEBE declarar **exactamente un Tipo de Módulo** en su Contrato de Capacidad.

> **Un Tipo de Módulo es una declaración de primera clase de tenencia, autoridad de ciclo de vida, semántica de falla y garantías de aislamiento.**

El Tipo de Módulo **no es una sugerencia de optimización** — es un **contrato rígido** aplicado por el Core, las herramientas y la política.

Un Módulo DEBE ser rechazado si su comportamiento en tiempo de ejecución contradice su tipo declarado.

---

### 6.1 Declaración de Tipo de Módulo (Normativa)

Cada Contrato de Capacidad de Módulo DEBE declarar, como mínimo:

* `module_type` 
* `tenancy_model`
* `lifecycle_authority`
* `lease_dependency`
* `state_persistence_policy`
* `side_effect_policy`

Estas declaraciones son **autoritativas** y DEBEN ser validadas durante el handshake.

---

### 6.2 Tipo I — Módulo Privado Efímero

#### 6.2.1 Definición Declarativa

**Los Módulos Tipo I son:**

* **Efímeros**
* **Mono-inquilino**
* **Estrictamente vinculados a lease**
* **Controlados por el ciclo de vida del Core**

Existen *solo* para servir a una **única instancia de Core durante la duración de un lease activo**.

> Un módulo Tipo I no tiene significado fuera de un lease válido.

---

#### 6.2.2 Propiedades Declarativas

| Propiedad              | Valor                                    |
| ---------------------- | ---------------------------------------- |
| Modelo de tenencia     | Core Único                               |
| Autoridad de ciclo     | Core                                     |
| Dependencia de lease   | Obligatoria                              |
| Efectos secundarios    | Deben ser reversibles o no permitidos    |
| Modo de inicio         | Solo emitido por el Core                 |

---

#### 6.2.3 Semántica de Ciclo de Vida

* El Core es la **única autoridad** permitida para iniciar el módulo.
* El módulo DEBE aceptar leases de **exactamente un URN de Instancia de Core** definido en el inicio.
* El Estado de Lease-Cero lleva inevitablemente a la terminación elegante después de un Período de Gracia de Recuperación de Tarea.
* Períodos de Gracia de Recuperación de Tarea:

  * DEBEN ser acotados
  * NO DEBEN ser renovables
  * DEBEN rechazar todo el tráfico sin lease

> **Un módulo Tipo I sin un lease se considera muerto, incluso si su proceso aún está en ejecución.**

---

### 6.3 Tipo II — Módulo Privado Residente

#### 6.3.1 Definición Declarativa

**Los Módulos Tipo II son:**

* **Residentes**
* **Mono-inquilino**
* **Protegidos por lease**
* **Afiliados al Core**

Son procesos de larga duración que sirven a **exactamente un Core**, pero cuya existencia no está estrictamente vinculada a la duración del lease.

---

#### 6.3.2 Propiedades Declarativas

| Propiedad              | Valor                                  |
| ---------------------- | -------------------------------------- |
| Modelo de tenencia     | Core Único                             |
| Autoridad de ciclo     | Core o Infraestructura                 |
| Dependencia de lease   | Obligatoria para ejecución             |
| Efectos secundarios    | Permitidos dentro del alcance de lease |
| Modo de inicio         | Emitido por Core o pre-iniciado        |

---

#### 6.3.3 Semántica de Ciclo de Vida

* El módulo DEBE vincularse permanentemente a un único URN de Core.
* El Estado de Lease-Cero coloca al módulo en **Modo Standby**.
* En Modo Standby:

  * La ejecución está prohibida
  * Cualquier ejecución se detiene en el siguiente punto de interrupción declarado, según sus garantías de abortabilidad.
* La restauración y creación de lease DEBEN venir del mismo Core.
* Cualquier estado de tarea en curso PUEDE retenerse solo durante la duración del Período de Gracia de Recuperación de Tarea.


> **Un módulo Tipo II sin un lease está inerte, no terminado.**

---

### 6.4 Tipo III — Módulo Residente Compartido

#### 6.4.1 Definición Declarativa

**Los Módulos Tipo III son:**

* **Residentes**
* **Multi-inquilino**
* **Particionados por lease**
* **Gobernados por infraestructura**

Están diseñados para servir de manera segura a **múltiples Cores independientes concurrentemente**.

> Tipo III es una **clase de confianza opt-in**, no un valor predeterminado.

---

#### 6.4.2 Propiedades Declarativas

| Propiedad              | Valor                           |
| ---------------------- | ------------------------------- |
| Modelo de tenencia     | Multi-Core                      |
| Autoridad de ciclo     | Infraestructura                 |
| Dependencia de lease   | Obligatoria por inquilino       |
| Efectos secundarios    | Solo aislados por lease         |
| Modo de inicio         | Emitido por la infraestructura  |

---

#### 6.4.3 Semántica de Aislamiento y Comportamiento

* Cada Core DEBE estar aislado por:

  * ID de Lease
  * URN del Core
* Todo el comportamiento DEBE estar dentro del alcance de un lease activo.
* La presencia o el comportamiento de un Core NO DEBE afectar a otro.
* El estado del Período de Gracia de Recuperación de Tarea DEBE estar aislado por ID de Lease y destruirse independientemente.

> **Cualquier influencia entre inquilinos se considera una violación de seguridad. Y causará la Lista Negra del Módulo.**

Pueden requerirse verificaciones regulares de cumplimiento y verificación formal para módulos Tipo III por los equipos de ANIMA, a fin de garantizar el cumplimiento estricto de las garantías de aislamiento.

---

#### 6.4.4 Semántica de Ciclo de Vida

* La expiración del lease afecta solo al Core propietario.
* La transición a Lease-Cero global coloca al módulo en Modo Standby, similar al Tipo II.
* La terminación está controlada exclusivamente por la infraestructura o los administradores.

---

### 6.5 Configuraciones Inválidas (Normativa)

Las siguientes combinaciones son **inválidas** y DEBEN ser rechazadas:

* Cualquier módulo que registre estado persistente por más tiempo que un Período de Gracia de Recuperación de Tarea
* Cualquier módulo que permita efectos secundarios sin aplicación de lease
* Cualquier módulo que ejecute lógica de capacidad sin un lease
* Cualquier módulo cuyo comportamiento observado contradiga su tipo declarado

---

### 6.6 Invariante de Diseño

> **El Tipo de Módulo es un límite de seguridad, no un detalle de implementación.**

Cambiar el tipo de un módulo es un **cambio de ruptura** que requiere:

* Actualización del contrato de capacidad
* Revisión de política
* Reimplementación
  
 
## 7. Gobernanza y Seguridad del Tipo III

Los módulos Tipo III operan bajo **gobernanza explícita** y requisitos de seguridad:

DEBEN proporcionar:

* Garantías de determinismo
* Auto-pruebas de aislamiento
* Aplicación de comportamiento con alcance de lease
* Ganchos de auditoría

Las violaciones resultan en:

* Revocación inmediata de lease
* Lista negra
* Reimplementación obligatoria o sandboxing

Los módulos de terceros DEBEN pasar verificaciones formales de cumplimiento o ejecutarse en sandboxes proporcionados por ANIMA.

---

## 8. Persistencia de Estado y Períodos de Gracia de Recuperación de Tarea

La ausencia de estado en ANIMA significa la ausencia de estado duradero entre leases o reinicios.
No prohíbe efectos secundarios transitorios que son completamente atribuibles a un único lease y declarados explícitamente en el contrato de capacidad.

Los Módulos ANIMA deben ser arquitectónicamente sin estado.
Todo el comportamiento observable debe ser atribuible a entradas explícitas, un lease activo y computación determinística. El estado retenido durante el Período de Gracia de Recuperación de Tarea NO DEBE desencadenar nueva ejecución o efectos secundarios.

Todos los módulos DEBEN diseñarse sin persistencia de estado más allá de lo siguiente:
* Estado en memoria durante tareas activas
* Almacenamiento efímero con alcance de leases activos
* Recursos de solo lectura pesados de inicialización cargados en el inicio, tales recursos DEBEN ser determinísticos, inmutables e idénticos entre reinicios.
* Los cachés deben ser:
  * con alcance de una única ejecución de tarea, o
  * con alcance de un único lease activo y destruidos en la expiración del lease.

El almacenamiento de estado persistente entre reinicios o ciclos de lease está prohibido.

Los Períodos de Gracia de Recuperación de Tarea DEBEN ser:
* Un intervalo acotado durante el cual el estado de tarea en curso puede retenerse únicamente para respaldar rollback, retry o reporte de error para un único lease.
* No renovable y no extendible.
* No accesible para nuevos leases o tareas.

---
## 9. Observabilidad y Seguridad de Canal Lateral

* La observabilidad es obligatoria pero **con alcance de lease**.
* Los traces, métricas y logs DEBEN:

  * Nunca exponer correlaciones de tiempo entre inquilinos
  * Estar aislados por Core / Lease
* Los módulos compartidos DEBEN redactar metadatos identificadores de inquilino.

La observabilidad NO DEBE convertirse en un canal de información.

---

## Consecuencias

### Positivas

* Única fuente de verdad de autorización
* Ejecución segura contra repetición y determinística
* Límites de contención explícitos
* Fuerte aislamiento multi-inquilino
* Seguro ante fallas por defecto

### Negativas

* Mayor rigor de implementación
* Mayor carga de cumplimiento para módulos compartidos

---

## Resumen


> **Los Módulos ANIMA son Privados Efímeros (Tipo I), Privados Residentes (Tipo II), o Residentes Compartidos (Tipo III).**
> **Toda ejecución está protegida por leases criptográficos emitidos por el Core sobre mTLS.**
> **Sin un lease válido, un módulo está inerte o muerto. No hay excepciones.**
> **Los cambios de alcance son explícitos, auditables y unidireccionales.**
> **Los tipos de módulos definen semántica estricta de ciclo de vida y tenencia.**
> **La persistencia de estado está prohibida más allá de Períodos de Gracia de Recuperación de Tarea acotados.**
