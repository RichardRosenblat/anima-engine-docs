# ADR-007: Capa de Infraestructura y Reglas de Adaptador

**Estado:** Aceptado
**Fecha:** 2026-01-04
**Decisores:** @RichardRosenblat
**Contexto:** Arquitectura Hexagonal, DDD, Composición en Runtime

---

## Contexto

ANIMA sigue **Arquitectura Hexagonal** y **Domain-Driven Design (DDD)**. A medida que el sistema crece, se requiere un límite claro y aplicable entre:

* **Lógica de dominio** (significado, reglas, invariantes)
* **Preocupaciones de infraestructura** (IO, bases de datos, sistemas externos)

Sin reglas estrictas, el código de infraestructura tiende a:

* Filtrarse a los dominios
* Codificar lógica de negocio implícitamente
* Convertirse en una colección no estructurada de implementaciones

Este ADR define:

* Por qué existe la carpeta `infra/`
* Qué está permitido dentro de ella
* Cómo está estructurada
* Cómo se conecta a dominios y runtime

---

## Principio Central

> **Los dominios nunca deben hablar directamente con el mundo externo.**

El mundo externo incluye:

* Bases de datos (Postgres, SQLite, Redis)
* Sistemas de archivos
* Servicios de red
* Message brokers
* Tiempo del OS, ambiente, entropía

Los dominios expresan sus necesidades a través de **interfaces (puertos)**.
La infraestructura satisface esas necesidades a través de **adaptadores**.

---

## Por Qué Existe la Carpeta `infra/`

La carpeta `infra/` existe para:

* Aislar toda interacción de IO y sistema externo
* Implementar interfaces definidas por el dominio (puertos)
* Permitir reemplazo de tecnologías sin tocar los dominios
* Mantener la lógica de dominio pura, probable y estable

La infraestructura **no** es parte del modelo de dominio.

---

## Relación Dominio ↔ Infraestructura

### Dirección de Dependencia (No Negociable)

```
infra  ─────▶  domains
runtime ────▶  infra + domains

domains ─╳──▶  infra
```

Reglas:

* Los dominios **definen puertos** (interfaces / abstracciones)
* Infra **implementa puertos**
* Los dominios **nunca importan infra**
* Runtime es la única capa permitida para importar y conectar todo

---

## Puertos de Dominio (Interfaces)

Los dominios definen **puertos** para cualquier cosa que sea externa o variable.

Ejemplos:

* Repositorios
* Buses de eventos
* Relojes
* Almacenamientos de archivos
* Despachadores de mensajes

```python
# domains/orders/ports.py
from typing import Protocol

class OrderRepository(Protocol):
    def save(self, order: Order) -> None: ...
```

Los dominios dependen **solo** de estas abstracciones.

---

## Adaptadores de Infraestructura

Los adaptadores de infraestructura:

* Implementan exactamente un puerto de dominio
* Contienen cero lógica de negocio
* Traducen entre conceptos de dominio y sistemas externos

```python
# infra/persistence/postgres/order_repository.py
from domains.orders.ports import OrderRepository

class PostgresOrderRepository(OrderRepository):
    def save(self, order: Order) -> None:
        ...
```

---

## Estructura de la Carpeta Infra

La infraestructura está estructurada por **tecnología**, luego por **responsabilidad del adaptador**.

```
/infra
  __main__.py
  /persistence
    /postgres
      __main__.py
      order_repository.py
      user_repository.py
      memory_repository.py

    /sqlite
      __main__.py
      order_repository.py

  /messaging
    /kafka
      __main__.py
      domain_event_bus.py

  /clock
      __main__.py
    system_clock.py
```

### Reglas de Estructura

1. Un adaptador por archivo
2. Cada adaptador implementa exactamente un puerto de dominio
3. Sin lógica de dominio en infra
4. Sin importaciones entre adaptadores
5. Sin importaciones de dominio a infra

---

## Helpers Internos de Infra

Infra puede contener **helpers privados** para preocupaciones técnicas compartidas.

```
infra/persistence/postgres/
  __main__.py
  _connection.py
  _base_repo.py
  order_repository.py
```

Reglas:

* Los helpers tienen prefijo `_`
* Los helpers no son puertos
* Los helpers no son visibles a los dominios

---

## Responsabilidades del Runtime

Runtime es la **raíz de composición**.

Runtime:

* Selecciona implementaciones de infraestructura
* Instancia adaptadores
* Los inyecta en los dominios

```python
repo = PostgresOrderRepository(pool)
service = OrderService(repo)
```

Los dominios nunca deben realizar conexión o instanciación de infra.

---

## Prácticas Prohibidas

❌ Dominios importando implementaciones de infra
❌ Infra definiendo reglas de negocio
❌ Infra seleccionando implementaciones
❌ Coincidencia implícita de interfaz ("mismos nombres de método")
❌ Archivos de adaptador grandes multi-dominio

---

## Consecuencias

**Positivas:**

* Grafo de dependencia limpio
* Infraestructura reemplazable
* Alta testabilidad
* Estabilidad arquitectónica a largo plazo

**Negativas:**

* Más archivos
* Más conexión explícita
* Mayor disciplina inicial

Estos tradeoffs son intencionales.

---

## Principio Final

> **Los dominios describen la realidad.
> La infraestructura conecta la realidad al mundo externo.
> Runtime ensambla el sistema.**
