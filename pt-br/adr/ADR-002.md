# ADR-002: Esquemas Auto-Validáveis com Restrições Apenas Internas

## Status
**Status:** Aceito  
**Data:** 2025-12-31  
**Decisores:** @RichardRosenblat  
**Contexto:** Design de esquema, pureza de domínio, integridade de dados  

## Contexto

A ANIMA depende fortemente de esquemas de dados estruturados para definir:

- registros de memória
- representações de intenção
- planos e estruturas semânticas
- definições de seed
- descritores de capacidade

Esses esquemas formam a **fundação da correção do motor**.  
Dados inválidos ou internamente inconsistentes neste nível podem comprometer segurança, continuidade de identidade e integridade do raciocínio.

Ao mesmo tempo, a ANIMA segue uma arquitetura hexagonal estrita, onde:

- esquemas pertencem à **camada de domínio pura**
- código de domínio não deve depender de sistemas externos, estado ou IO

Isso levanta a questão:

> Esquemas devem ter permissão para validar a si mesmos, e se sim, sob quais restrições?

---

## Decisão

Esquemas **PODEM** incluir lógica de auto-validação **apenas se**:

1. A validação:
   - usa **apenas os dados contidos dentro da instância do esquema**
   - depende exclusivamente de lógica pura
2. A validação:
   - **não** consulta estado externo
   - **não** depende de instâncias de runtime de outros esquemas
   - **não** realiza IO, acesso ao sistema de arquivos ou chamadas de rede
3. A validação:
   - é determinística
   - produz o mesmo resultado para os mesmos dados de entrada

Esquemas **NÃO DEVEM** realizar validação que requer:

- acesso a banco de dados
- armazenamentos de memória
- estado do motor
- histórico do usuário
- inferência de modelo
- condições baseadas em tempo ou ambiente

Se a validação requer dados ou contexto externos, ela **DEVE** ser implementada em uma camada superior (ex: validadores de seed, serviços do motor ou políticas de segurança).

---

## Exemplos

### ✅ Permitido (Consistência Interna)

- Verificações de intervalo de campos
- Validação de pertencimento a enum
- Consistência entre campos dentro do mesmo esquema
- Regras de integridade estrutural

```python
@dataclass(frozen=True)
class SemanticFact:
    content: str
    confidence: float

    def validate(self) -> None:
        if not (0.0 <= self.confidence <= 1.0):
            raise ValueError("confidence must be between 0 and 1")
```

### ❌ Proibido (Dependência Externa)

* Verificar se uma entidade referenciada existe na memória
* Verificar permissões
* Consultar interações históricas
* Chamar serviços do motor ou adaptadores

```python
# ❌ Não permitido em esquema
def validate(self, memory_store):
    if not memory_store.exists(self.reference_id):
        ...
```

---

## Justificativa

Permitir **validação apenas interna** fornece:

* Detecção precoce de erros
* Garantias de dados mais fortes
* Propriedade clara de invariantes
* Propagação reduzida de estado inválido

Restringir esquemas à **validação autocontida** preserva:

* Pureza da camada de domínio
* Testabilidade
* Comportamento determinístico
* Fluxo de dependência limpo para dentro

Isso equilibra segurança e disciplina arquitetural sem transformar esquemas em mini-serviços.

---

## Consequências

### Positivas

* Esquemas são robustos e auto-defensivos
* Dados inválidos falham rápido e localmente
* Lógica central do motor pode confiar em invariantes de esquema

### Negativas

* Alguma lógica de validação deve ser duplicada ou adiada para camadas superiores
* Desenvolvedores devem pensar cuidadosamente sobre o posicionamento de validação

Esse tradeoff é intencional e alinhado com a ênfase da ANIMA em correção sobre conveniência.

---

## Aplicação

* Módulos de esquema NÃO DEVEM importar serviços do motor, adaptadores ou código de runtime
* Métodos de validação de esquema DEVEM ser facilmente testáveis em isolamento
* Revisões de código DEVEM rejeitar validação de esquema que depende de contexto externo

---

## Notas

Este ADR **não** exige que todos os esquemas implementem validação — apenas que **se a validação existe**, ela deve respeitar essas restrições.
