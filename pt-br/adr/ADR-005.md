# ADR-005: Modelo de Interrupção e Preempção

**Status:** Aceito  
**Data:** 2026-01-03  
**Decisores:** @RichardRosenblat  
**Contexto:** Interação, Segurança, Controle em Tempo Real, Observabilidade, Determinismo  

---

## Contexto

A ANIMA é projetada para operar em **ambientes interativos ao vivo** onde usuários, sistemas e sensores podem fornecer entrada enquanto a instância já está:

* falando
* raciocin

ando
* executando um plano
* invocando capacidades de longa duração
* interagindo com o mundo externo

Em tais ambientes, **interrupções são inevitáveis**.

Tratamento ingênuo de interrupções (ex: matar threads, cancelamentos forçados, flags ad-hoc) introduz riscos severos:

* estado interno inconsistente
* ações parcialmente executadas
* perda de auditabilidade
* comportamento não determinístico
* efeitos colaterais externos inseguros

Portanto, a ANIMA requer um **modelo de interrupção formal, determinístico e observável** que preserve segurança e clareza arquitetural enquanto permite interação natural.

---

## Decisão

### 1. Interrupções São Eventos de Primeira Classe

Interrupções **não são exceções**, sinais ou canais laterais.

Todas as interrupções DEVEM entrar no sistema como **eventos de entrada estruturados**, processados pelo Núcleo como qualquer outra entrada.

Exemplos incluem:

* fala do usuário enquanto ANIMA está falando
* comandos do usuário emitidos durante execução
* gatilhos de segurança do sistema
* alertas emitidos por capacidades

Interrupções DEVEM ser:

* observáveis
* auditáveis
* reproduzíveis
* atribuíveis a uma fonte

---

### 2. Modelo de Execução: Spans e Foco

Toda atividade do Núcleo é representada como **spans de execução**, cada um com:

* um `span_id` único
* um `execution_id` associado
* uma flag `interruptible` declarada
* uma política de interrupção

A qualquer momento, o Núcleo mantém um **span de foco em primeiro plano**.

Por padrão:

* apenas o span em primeiro plano pode ser interrompido
* trabalho em segundo plano continua a menos que explicitamente escalado

Isso previne cancelamento em cascata descontrolado.

---

### 3. Interruptibilidade É Explícita

Nenhuma ação é interrompível por padrão.

Apenas spans que declarem explicitamente:

```yaml
interruptible: true
```

podem ser interrompidos.

Isso inclui, mas não está limitado a:

* streaming de fala
* escuta
* movimento
* espera
* execução de capacidade de longa duração

Spans não interrompíveis DEVEM ignorar eventos de interrupção.

---

### 4. Classificação de Interrupção

Ao receber um evento de interrupção, o Núcleo DEVE classificá-lo antes de agir.

Classes de interrupção suportadas incluem:

| Classe          | Semântica                                  |
| --------------- | ------------------------------------------ |
| `override`      | Substituir execução atual em primeiro plano|
| `cancel`        | Parar a execução atual                     |
| `queue`         | Adiar até que execução atual complete     |
| `clarification` | Interromper para solicitar clarificação   |
| `emergency`     | Parada imediata, ignorando fluxo normal   |

Classificação é um **passo de raciocínio**, não um reflexo.

---

### 5. Políticas de Interrupção de Capacidades

Capacidades que expõem métodos interrompíveis DEVEM declarar uma **política de interrupção** por método.

Políticas suportadas incluem:

| Política            | Comportamento                              |
| ------------------- | ------------------------------------------ |
| `soft-stop`         | Parar em um limite seguro (ex: fim buffer) |
| `hard-stop`         | Terminação imediata                        |
| `checkpointed`      | Reverter ao último checkpoint seguro       |
| `non-interruptible` | Rejeitar todas as interrupções             |

O Núcleo DEVE respeitar políticas declaradas.
Capacidades DEVEM aplicá-las localmente.

---

### 6. Fluxo de Tratamento de Interrupção

Quando uma interrupção ocorre:

1. Um evento de entrada de interrupção é emitido
2. O Núcleo avalia:

   * span atual em primeiro plano
   * interruptibilidade
   * classificação de interrupção
   * limiares de segurança e confiança
3. Se permitido:

   * o span alvo é marcado como `interrupted`
   * uma diretiva de interrupção é enviada à capacidade (se aplicável)
4. O span interrompido:

   * termina de acordo com sua política
   * emite eventos de conclusão ou cancelamento
5. Um **novo traço de execução** começa

Traços interrompidos **nunca são mutados ou deletados**.

---

### 7. Falar Enquanto Fala (Caso Canônico)

Se ANIMA está ativamente falando e fala do usuário é detectada:

* detecção de fala entra como evento de interrupção
* o Núcleo avalia confiança e permissões
* se classificado como `override` ou `cancel`:

  * o span de fala é interrompido
  * a capacidade de voz executa um `soft-stop`
  * controle retorna ao Núcleo
  * uma nova execução começa

Nenhuma terminação forçada de processo é permitida.

---

### 8. Segurança e Mitigação de Abuso

Interrupções podem ser maliciosas ou acidentais.

O Núcleo DEVE aplicar:

* limiares de confiança (ex: certeza de fala)
* limites de taxa
* permissões baseadas em função
* regras de escalação para interrupções de emergência

Exemplos:

* apenas funções privilegiadas podem emitir interrupções `emergency`
* entradas de baixa confiança podem ser enfileiradas ou ignoradas

---

### 9. Observabilidade e Rastreabilidade

Todas as interrupções DEVEM gerar eventos de linha do tempo, incluindo:

* fonte da interrupção
* span alvo
* classificação
* política aplicada
* resultado

Isso se integra diretamente com o modelo de observabilidade baseado em eventos definido em ADR-004.

Interrupções DEVEM ser claramente visíveis em linhas do tempo de execução.

---

## Consequências

### Positivas

* Interação natural, semelhante à humana
* Comportamento de interrupção determinístico
* Fortes garantias de segurança
* Auditabilidade e reprodutibilidade completas
* Separação limpa entre entrada, raciocínio e execução

### Negativas

* Complexidade de modelagem aumentada
* Requer design explícito de capacidades
* Mais disciplina inicial na modelagem de execução

Esses tradeoffs são intencionais.

---

## Não-Objetivos

Este ADR **não** define:

* padrões de interação UI/UX
* algoritmos de confiança de reconhecimento de fala
* tratamento de interrupção em nível de hardware
* agendamento de SO em tempo real

Estes são delegados a módulos e camadas de infraestrutura.

---

## Resumo

> **Interrupções na ANIMA são eventos de entrada estruturados e classificados que preemptam execução de maneira controlada, observável e determinística.**

Elas são:

* explícitas
* governadas por política
* auditáveis
* seguras por construção

Este modelo permite interação em tempo real sem sacrificar integridade arquitetural.
