# ADR-004: Observabilidade, Registro de Eventos e Rastreabilidade de Execução

**Status:** Aceito  
**Data:** 2026-01-03  
**Decisores:** @RichardRosenblat  
**Contexto:** Observabilidade, Depurabilidade, Determinismo, Concorrência, Auditabilidade, Distribuição Futura  

---

## Contexto

A ANIMA é um sistema altamente modular e concorrente composto por:

* um Núcleo de raciocínio
* múltiplos Módulos executando independentemente
* invocações assíncronas de capacidades
* threads de execução concorrentes
* leases limitados por tempo e decisões de segurança

Abordagens tradicionais de registro baseadas em:

* linhas de texto não estruturadas
* arquivos de log globais
* ordenação apenas por tempo

são insuficientes e ativamente prejudiciais neste contexto.

Elas falham em fornecer:

* relacionamentos causais
* limites de execução
* clareza de concorrência
* reprodutibilidade
* rastreabilidade de nível de auditoria

A ANIMA requer observabilidade que reflita **o que realmente acontece**, não apenas *quando* algo imprimiu texto.

---

## Declaração do Problema

O sistema deve suportar:

* múltiplas execuções concorrentes
* threads de raciocínio paralelas
* módulos distribuídos
* clustering futuro
* auditoria de segurança
* depuração legível por humanos
* análise legível por máquinas

Sem estrutura e isolamento estritos, dados de observabilidade tornam-se:

* ambíguos
* inseguros para interpretar
* difíceis de correlacionar
* impossíveis de reproduzir confiavelmente

---

## Decisão

### 1. Modelo de Observabilidade Baseado em Eventos

A ANIMA **não** produz linhas de log tradicionais.

Em vez disso, **toda saída de observabilidade é expressa como eventos estruturados**.

Um evento representa um **fato** que ocorreu no sistema.

Eventos são:

* imutáveis
* append-only
* marcados com timestamp
* causalmente ligados
* com escopo de execução

---

### 2. Execução como Limite de Partição Primário

Todos os dados de observabilidade DEVEM ser particionados por **execução**.

Uma **execução** é definida como:

* um runtime do Núcleo limitado
* um único universo causal
* o limite de isolamento de nível mais alto para observabilidade

Cada execução recebe um único globalmente único:

```
execution_id
```

Este ID:

* é gerado pelo Núcleo na inicialização (ou criação explícita de execução)
* é anexado a **cada evento**
* é propagado para **todos os Módulos**
* é incluído em contextos de lease

Tempo sozinho NÃO DEVE ser usado como chave de partição primária.

---

### 3. Sinks de Eventos Baseados em Arquivo (Implementação Inicial)

Para desenvolvimento inicial e execução local, a ANIMA usa **sinks baseados em arquivo**.

O layout de arquivo é **particionado por execução**:

```text
events/
  executions/
    exec-<uuid>/
      metadata.json
      events.ndjson
```

Onde:

* `metadata.json` descreve o contexto de execução
* `events.ndjson` é um stream de eventos JSON delimitado por nova linha append-only

---

### 4. Metadados de Execução

Cada diretório de execução DEVE conter metadados descrevendo a execução.

Exemplo:

```json
{
  "execution_id": "exec-9f3c2a7e",
  "started_at": "2026-01-01T18:04:12Z",
  "ended_at": null,
  "core_version": "0.4.0",
  "host": "anima-core-01"
}
```

Estes metadados fornecem:

* contexto humano
* rastreabilidade de auditoria
* ancoragem de replay

---

### 5. Estrutura de Evento (Campos Obrigatórios)

Cada evento DEVE incluir no mínimo:

```json
{
  "execution_id": "exec-uuid",
  "trace_id": "trace-uuid",
  "span_id": "span-uuid",
  "parent_span_id": null,
  "thread_id": "ctx-identifier",
  "timestamp": "RFC3339",
  "source": "core | module:<name>",
  "type": "event.type.identifier",
  "payload": {}
}
```

#### Responsabilidades semânticas:

* **execution_id** → isolamento de execução
* **trace_id** → cadeia causal de ponta a ponta
* **span_id / parent_span_id** → estrutura hierárquica
* **thread_id** → visibilidade de concorrência
* **type** → significado semântico (estável, documentado)
* **payload** → apenas dados estruturados (sem texto livre)

---

### 6. Garantias de Concorrência e Multithreading

Observabilidade DEVE suportar execução concorrente.

Isso é alcançado por:

* isolamento de arquivo em nível de execução
* escritas append-only
* identificadores em nível de thread em eventos

Não há **nenhum requisito** de ordenação total entre threads.
Ordenação é derivada de:

* relacionamentos de trace
* hierarquias de span
* timestamps como contexto secundário

---

### 7. Legibilidade Humana e Visualização de Linha do Tempo

Embora eventos sejam JSON legível por máquina, o modelo é projetado para suportar:

* visualizadores de linha do tempo
* visualizações filtradas (por trace, thread, módulo)
* árvores de span recolhíveis
* ferramentas de replay

Legibilidade humana é alcançada através de:

* esquemas estruturados
* tipos de evento estáveis
* campos determinísticos
* ferramentas (não texto ad-hoc)

Arquivos brutos não são destinados a serem lidos diretamente.

---

### 8. Participação de Módulos

Todos os Módulos DEVEM:

* emitir eventos usando o mesmo esquema
* incluir execution_id propagado do Núcleo
* respeitar contexto de trace e span fornecido pelo Núcleo
* nunca emitir eventos fora de um contexto de execução

Módulos NÃO DEVEM:

* escrever diretamente em arquivos do Núcleo
* inventar execution IDs
* misturar dados de múltiplas execuções

---

### 9. Extensões Futuras

Este ADR intencionalmente permite sinks futuros, incluindo:

* armazenamentos de eventos centralizados
* pipelines de streaming
* backends de observabilidade
* sistemas de trace distribuído

Todas as implementações futuras DEVEM preservar:

* particionamento de execução
* semântica de evento imutável
* rastreabilidade causal

---

## Consequências

### Positivas

* Isolamento claro de execução
* Reprodutibilidade determinística
* Concorrência segura
* Observabilidade de nível de auditoria
* Base forte para ferramentas
* Sem ambiguidade de intercalação de log

### Negativas

* Requer disciplina de esquema inicial
* Ferramentas necessárias para visualização
* Menos "depuração por impressão" imediata

Esses tradeoffs são intencionais e alinhados com os objetivos da ANIMA.

---

## Não-Objetivos

Este ADR **não** define:

* dashboards em tempo real
* sistemas de alerta
* infraestrutura de agregação de log
* políticas de armazenamento de longo prazo
* UX de ferramentas de visualização

Estes são abordados separadamente.

---

## Resumo

> **A ANIMA não registra texto.
> A ANIMA registra fatos.**
>
> Observabilidade é:
>
> * estruturada
> * com escopo de execução
> * causalmente rastreável
> * segura para concorrência
>
> Execução é o limite fundamental.
> Eventos são a fonte da verdade.
