# ADR-007: Camada de Infraestrutura e Regras de Adaptador

**Status:** Aceito
**Data:** 2026-01-04
**Decisores:** @Richard Rosenblat
**Contexto:** Arquitetura Hexagonal, DDD, Composição em Runtime

---

## Contexto

A ANIMA segue **Arquitetura Hexagonal** e **Domain-Driven Design (DDD)**. À medida que o sistema cresce, um limite claro e aplicável é necessário entre:

* **Lógica de domínio** (significado, regras, invariantes)
* **Preocupações de infraestrutura** (IO, bancos de dados, sistemas externos)

Sem regras estritas, o código de infraestrutura tende a:

* Vazar para os domínios
* Codificar lógica de negócio implicitamente
* Tornar-se uma coleção não estruturada de implementações

Este ADR define:

* Por que a pasta `infra/` existe
* O que é permitido dentro dela
* Como ela é estruturada
* Como ela se conecta aos domínios e runtime

---

## Princípio Central

> **Domínios nunca devem falar diretamente com o mundo externo.**

O mundo externo inclui:

* Bancos de dados (Postgres, SQLite, Redis)
* Sistemas de arquivos
* Serviços de rede
* Message brokers
* Tempo do OS, ambiente, entropia

Domínios expressam suas necessidades através de **interfaces (portas)**.
A infraestrutura atende essas necessidades através de **adaptadores**.

---

## Por Que a Pasta `infra/` Existe

A pasta `infra/` existe para:

* Isolar toda interação de IO e sistema externo
* Implementar interfaces definidas pelo domínio (portas)
* Permitir substituição de tecnologias sem tocar nos domínios
* Manter a lógica de domínio pura, testável e estável

Infraestrutura **não** é parte do modelo de domínio.

---

## Relacionamento Domínio ↔ Infraestrutura

### Direção de Dependência (Não Negociável)

```
infra  ─────▶  domains
runtime ────▶  infra + domains

domains ─╳──▶  infra
```

Regras:

* Domínios **definem portas** (interfaces / abstrações)
* Infra **implementa portas**
* Domínios **nunca importam infra**
* Runtime é a única camada permitida para importar e conectar tudo

---

## Portas de Domínio (Interfaces)

Domínios definem **portas** para qualquer coisa que seja externa ou variável.

Exemplos:

* Repositórios
* Barramentos de eventos
* Relógios
* Armazenamentos de arquivos
* Despachantes de mensagens

```python
# domains/orders/ports.py
from typing import Protocol

class OrderRepository(Protocol):
    def save(self, order: Order) -> None: ...
```

Domínios dependem **apenas** dessas abstrações.

---

## Adaptadores de Infraestrutura

Adaptadores de infraestrutura:

* Implementam exatamente uma porta de domínio
* Contêm zero lógica de negócio
* Traduzem entre conceitos de domínio e sistemas externos

```python
# infra/persistence/postgres/order_repository.py
from domains.orders.ports import OrderRepository

class PostgresOrderRepository(OrderRepository):
    def save(self, order: Order) -> None:
        ...
```

---

## Estrutura da Pasta Infra

A infraestrutura é estruturada por **tecnologia**, depois por **responsabilidade do adaptador**.

```
/infra
  __main__.py
  /persistence
    /postgres
      __main__.py
      order_repository.py
      user_repository.py
      memory_repository.py

    /sqlite
      __main__.py
      order_repository.py

  /messaging
    /kafka
      __main__.py
      domain_event_bus.py

  /clock
      __main__.py
    system_clock.py
```

### Regras de Estrutura

1. Um adaptador por arquivo
2. Cada adaptador implementa exatamente uma porta de domínio
3. Sem lógica de domínio na infra
4. Sem importações entre adaptadores
5. Sem importações de domínio para infra

---

## Helpers Internos de Infra

Infra pode conter **helpers privados** para preocupações técnicas compartilhadas.

```
infra/persistence/postgres/
  __main__.py
  _connection.py
  _base_repo.py
  order_repository.py
```

Regras:

* Helpers são prefixados com `_`
* Helpers não são portas
* Helpers não são visíveis aos domínios

---

## Responsabilidades do Runtime

Runtime é a **raiz de composição**.

Runtime:

* Seleciona implementações de infraestrutura
* Instancia adaptadores
* Injeta-os nos domínios

```python
repo = PostgresOrderRepository(pool)
service = OrderService(repo)
```

Domínios nunca devem realizar conexão ou instanciação de infra.

---

## Práticas Proibidas

❌ Domínios importando implementações de infra
❌ Infra definindo regras de negócio
❌ Infra selecionando implementações
❌ Correspondência implícita de interface ("mesmos nomes de método")
❌ Arquivos de adaptador grandes multi-domínio

---

## Consequências

**Positivas:**

* Grafo de dependência limpo
* Infraestrutura substituível
* Alta testabilidade
* Estabilidade arquitetural de longo prazo

**Negativas:**

* Mais arquivos
* Mais conexão explícita
* Maior disciplina inicial

Esses tradeoffs são intencionais.

---

## Princípio Final

> **Domínios descrevem a realidade.
> Infraestrutura conecta a realidade ao mundo externo.
> Runtime monta o sistema.**
